<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Dados</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
            background: #f4f4f4;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            background: white;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th {
            background: #007BFF;
            color: white;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 10px 0 0;
        }

        button:hover {
            background-color: #45a049;
        }

        canvas {
            width: 100% !important;
            max-width: 600px;
            margin: 20px auto;
            display: block;
        }

        .tabs {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 20px;
        }

        .tab {
            background: #007BFF;
            color: white;
            padding: 10px 20px;
            margin-right: 5px;
            cursor: pointer;
            border-radius: 5px;
        }

        .tab:hover {
            background: #0056b3;
        }

        .tab.active {
            background: #0056b3;
            color: #f4f4f4;
        }

        .tab-content {
            background: #fff;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            max-height: 70vh;
            /* limita altura do conte√∫do */
            overflow-y: auto;
            /* adiciona rolagem vertical */
            word-wrap: break-word;
            /* quebra palavras longas */
        }

        pre {
            white-space: pre-wrap;
            /* permite quebra de linha dentro de <pre> */
            word-wrap: break-word;
            /* quebra palavras muito grandes */
            font-family: "Courier New", monospace;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
        }

        pre {
            background: #f0f0f0;
            padding: 12px;
            border-left: 4px solid #007BFF;
            font-size: 15px;
            line-height: 1.5;
        }
    </style>
</head>

<body>
    <h2>üìä Visualizador de Dados</h2>

    <div class="tabs">
        <div id="tab-tabela" class="tab active">Tabela de Dados</div>
        <div id="tab-relatorio" class="tab">Relat√≥rio</div>
        <div id="tab-graficos" class="tab">Gr√°ficos</div>
    </div>

    <!-- TABELA -->
    <div id="tabela" class="tab-content">
        <table id="dados">
            <tr>
                <td>Carregando dados...</td>
            </tr>
        </table>
    </div>

    <!-- RELAT√ìRIO -->
    <div id="relatorio" class="tab-content" style="display:none;">
        <h3>üßæ Relat√≥rio</h3>
        <p>Os dados ainda n√£o foram enviados.</p>
    </div>

    <!-- GR√ÅFICOS -->
    <div id="graficos" class="tab-content" style="display:none;">
        <h3>üìà Gr√°ficos Gerados</h3>
        <canvas id="grafico"></canvas>
    </div>

    <button id="btnGemini">Gerar Insights com Gemini</button>
    <button id="btnRelatorio">Gerar Relat√≥rio Local</button>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <script>
        let dadosRecebidos = [];

        // === BUSCA OS DADOS DA PLANILHA ===
        function fetchData() {
            const scriptUrl = 'https://script.google.com/macros/s/AKfycbz3ZqxsuRmERlXO_hZ-ZWa8kiCrqsDZlsOVxCteeo5nATki73jsfUGqsGo53BCFhTnLhw/exec';
            fetch(scriptUrl)
                .then(response => response.json())
                .then(data => {
                    console.log("‚úÖ Dados recebidos:", data);
                    dadosRecebidos = data;
                    displayData(data);
                    updateGraph(data);
                })
                .catch(error => {
                    console.error('‚ùå Erro ao obter dados:', error);
                    document.getElementById("dados").innerHTML =
                        "<tr><td colspan='100%'>Erro ao carregar os dados.</td></tr>";
                });
        }

        // === EXIBE OS DADOS NA TABELA ===
        function displayData(data) {
            const tabela = document.getElementById("dados");

            if (!data || data.length === 0) {
                tabela.innerHTML = "<tr><td colspan='100%'>Nenhum dado encontrado.</td></tr>";
                return;
            }

            let html = "<tr>";
            Object.keys(data[0]).forEach(cab => {
                html += `<th>${cab}</th>`;
            });
            html += "</tr>";

            data.forEach(row => {
                html += "<tr>";
                Object.values(row).forEach(valor => {
                    html += `<td>${valor}</td>`;
                });
                html += "</tr>";
            });

            tabela.innerHTML = html;
        }

        // === ATUALIZA O GR√ÅFICO COM OS DADOS ===
        function updateGraph(data) {
            if (!data || data.length === 0) return;

            const container = document.getElementById("graficos");
            container.innerHTML = "<h3>üìà Gr√°ficos Gerados</h3>"; // limpa antes de recriar

            // Agrupa por tipo de sensor
            const sensores = {};
            data.forEach(row => {
                const sensor = row.Sensor;
                if (!sensores[sensor]) sensores[sensor] = [];
                sensores[sensor].push(row);
            });

            // Cria um gr√°fico para cada tipo de sensor
            Object.keys(sensores).forEach(sensor => {
                const registros = sensores[sensor];

                // Cria um canvas para cada gr√°fico
                const canvas = document.createElement("canvas");
                canvas.id = `grafico-${sensor}`;
                container.appendChild(canvas);

                const labels = registros.map(r => r.Timestamp);
                const valores = registros.map(r => parseFloat(r.Valor));

                new Chart(canvas.getContext("2d"), {
                    type: "line",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Valores do Sensor: ${sensor}`,
                            data: valores,
                            borderColor: "#007BFF",
                            backgroundColor: "rgba(0,123,255,0.2)",
                            borderWidth: 2,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `Sensor: ${sensor}`,
                                font: { size: 16 }
                            }
                        },
                        scales: {
                            x: { title: { display: true, text: "Timestamp" } },
                            y: { beginAtZero: true, title: { display: true, text: "Valor" } }
                        }
                    }
                });
            });
        }


        // === GERA INSIGHTS CURTOS COM GEMINI ===
        async function sendDataToGemini() {
            if (!dadosRecebidos.length) {
                alert("Nenhum dado dispon√≠vel para enviar.");
                return;
            }

            const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=AIzaSyDJLuHCpIDVOzXIzeLVg9OOp2vF2PnSlWg";
            let textData = "Aqui est√£o os dados de sensores:\n";
            dadosRecebidos.forEach(row => {
                textData += `Sensor: ${row.Sensor}, Valor: ${row.Valor}, Nota: ${row.Nota}, Hora: ${row.Timestamp}\n`;
            });

            /*const prompt =
              "Analise os dados abaixo e gere insights curtos e objetivos em portugu√™s. " +
              "Responda com frases breves, sem explica√ß√µes longas. " +
              "Exemplo: 'Sensor 1 est√°vel', 'Temperatura em leve alta', 'Varia√ß√£o detectada no sensor 3'.\n\n" +
              textData;
          */
            const prompt = "(Responda sem markdown, apenas texto)Gere um relat√≥rio bem detalhado, por√©m sucinto, sobre esses dados com insights √∫teis: " + textData;

            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log("‚úÖ Resposta do Gemini:", result);

                const insights = result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "Sem resposta do Gemini.";

                document.getElementById("relatorio").innerHTML =
                    `<h3>üí° Insights do Gemini</h3><pre>${insights}</pre>`;

                speakText(insights);
                setActiveTab("tab-relatorio");
            } catch (err) {
                console.error("‚ùå Erro ao enviar dados para o Gemini:", err);
                alert("Erro ao enviar para o Gemini. Veja o console.");
            }
        }

        // === GERA RELAT√ìRIO LOCAL ===
        function generateReport() {
            const reportContainer = document.getElementById("relatorio");

            if (!dadosRecebidos.length) {
                reportContainer.innerHTML = "<p>Nenhum dado dispon√≠vel para gerar o relat√≥rio.</p>";
                return;
            }

            let reportText = "Relat√≥rio Local:\n\n";
            dadosRecebidos.forEach(row => {
                reportText += `Sensor: ${row.Sensor}, Valor: ${row.Valor}, Nota: ${row.Nota}\n`;
            });

            reportContainer.innerHTML = `<h3>üßæ Relat√≥rio Gerado</h3><pre>${reportText}</pre>`;
            speakText("Relat√≥rio gerado com sucesso!");
            setActiveTab("tab-relatorio");
        }

        // === FALA O TEXTO ===
        function speakText(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "pt-BR";
            utterance.rate = 2.0;
            window.speechSynthesis.speak(utterance);
        }

        // === EVENTOS ===
        document.getElementById("btnGemini").addEventListener("click", sendDataToGemini);
        document.getElementById("btnRelatorio").addEventListener("click", generateReport);

        // === ABAS ===
        document.getElementById("tab-tabela").addEventListener("click", function () { setActiveTab("tab-tabela"); });
        document.getElementById("tab-relatorio").addEventListener("click", function () { setActiveTab("tab-relatorio"); });
        document.getElementById("tab-graficos").addEventListener("click", function () { setActiveTab("tab-graficos"); });

        function setActiveTab(tabId) {
            const tabs = document.querySelectorAll(".tab");
            tabs.forEach(tab => tab.classList.remove("active"));
            document.getElementById(tabId).classList.add("active");

            const contents = document.querySelectorAll(".tab-content");
            contents.forEach(content => content.style.display = "none");

            let contentId;
            if (tabId === "tab-tabela") contentId = "tabela";
            else if (tabId === "tab-relatorio") contentId = "relatorio";
            else if (tabId === "tab-graficos") contentId = "graficos";

            const activeContent = document.getElementById(contentId);
            if (activeContent) activeContent.style.display = "block";
        }

        // === IN√çCIO ===
        window.onload = fetchData;
    </script>
</body>

</html>
